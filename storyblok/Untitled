<script setup>
const props = defineProps({
  blok: {
    type: Object,
    required: true,
  },
})

// Tipo de background
const backgroundType = computed(() => {
  if (props.blok.backgroundVideo?.filename) return 'video'
  if (props.blok.backgroundImage?.filename) return 'image'
  if (props.blok.gradient_enabled) return 'gradient'
  return 'color'
})

// Estilo de fundo (apenas quando cor sólida)
const backgroundStyle = computed(() => {
  if (backgroundType.value === 'color' && props.blok.background_color?.color) {
    return { backgroundColor: props.blok.background_color.color }
  }
  return {}
})

// Classes de gradiente dinâmico
const gradientClasses = computed(() => {
  if (!props.blok.gradient_enabled) return ''
  const direction = props.blok.gradient_direction || 'bg-gradient-to-r'
  const from = props.blok.gradient_from || 'from-primary'
  const to = props.blok.gradient_to || 'to-secondary'
  return `${direction} ${from} ${to}`
})

// Classes de borda dinâmicas
const borderClasses = computed(() => {
  const style = props.blok.border_style || 'solid'
  const width = props.blok.border_width || '0'
  const color = props.blok.border_color || 'transparent'
  const radius = props.blok.rounded
    ? 'rounded-full'
    : props.blok.rounded_md
    ? 'rounded-md'
    : 'rounded-lg'

  return `border-${width} border-${color} border-${style} ${radius}`
})

// Classes de texto dinâmico
const textClasses = computed(() => {
  const colorMap = {
    light: 'text-gray-200',
    white: 'text-white',
    dark: 'text-gray-900',
    secondary: 'text-secondary',
    medium: 'text-gray-500',
    primary: 'text-primary',
  }
  const size = props.blok.text_size || 'base'
  return `${colorMap[props.blok.text_color] || 'text-black'} text-${size}`
})

// Background image otimizada
const optimizedImage = computed(() =>
  getOptimizedImage(props.blok.backgroundImage, 1200)
)

// Card linkável
const cardWrapper = computed(() => {
  if (props.blok.link_url) {
    return props.blok.link_url.startsWith('/')
      ? 'NuxtLink'
      : 'a'
  }
  return 'div'
})
</script>

<template>
  <component
    :is="cardWrapper"
    v-editable="blok"
    :to="blok.link_url?.startsWith('/') ? blok.link_url : null"
    :href="blok.link_url && !blok.link_url.startsWith('/') ? blok.link_url : null"
    class="relative flex h-full w-full max-w-md flex-col overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-lg"
    :class="[borderClasses, gradientClasses]"
    :style="backgroundStyle"
  >
    <!-- Background dinâmico -->
    <template v-if="backgroundType === 'image'">
      <img
        :src="optimizedImage"
        loading="lazy"
        class="absolute inset-0 z-0 w-full h-full object-cover pointer-events-none"
        :class="blok.rounded ? 'rounded-full' : ''"
      />
    </template>

    <template v-else-if="backgroundType === 'video'">
      <video
        autoplay
        muted
        loop
        playsinline
        class="absolute inset-0 z-0 w-full h-full object-cover pointer-events-none"
      >
        <source :src="blok.backgroundVideo.filename" type="video/mp4" />
      </video>
    </template>

    <!-- Overlay opcional -->
    <div
      v-if="blok.overlay_opacity"
      class="absolute inset-0 z-[1]"
      :style="`background-color: rgba(0,0,0,${blok.overlay_opacity})`"
    ></div>

    <!-- Conteúdo -->
    <div class="relative z-10 flex grow flex-col p-6">
      <div class="grow" :class="textClasses">
        <h3 class="mb-3 font-display font-bold" v-motion-slide-visible-left>
          {{ blok.label }}
        </h3>
        <div class="font-light leading-relaxed" v-motion-slide-visible-left>
          {{ blok.text }}
        </div>
      </div>

      <div v-if="blok.button?.length" class="mt-4" v-motion-fade-visible>
        <Button
          v-for="button in blok.button"
          :key="button._uid"
          :button="button"
        />
      </div>
    </div>
  </component>
</template>
